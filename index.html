<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SAP Astrology: Fast Tap AR</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        canvas.a-canvas { touch-action: none !important; }
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000; background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; color: white; text-align: center; padding: 20px;
        }

        .btn-start {
            padding: 20px 40px; font-size: 24px; border-radius: 12px;
            border: none; background: #e67e22; color: white; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px #d35400; transition: all 0.2s;
        }

        .btn-start:active { transform: translateY(2px); box-shadow: 0 2px #d35400; }

        .ui-panel { position: fixed; z-index: 1001; pointer-events: none; text-shadow: 2px 2px 4px #000; }

        /* Full screen flash overlay for feedback */
        #flash-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000; pointer-events: none; opacity: 0;
            transition: opacity 0.1s ease-in-out;
        }
    </style>
</head>

<body>

    <div id="flash-overlay"></div>

    <div id="overlay">
        <h1 style="color: #67e8f9; margin-bottom: 5px; letter-spacing: 2px;">SAP FAST TAP</h1>
        <p style="margin-bottom: 25px; opacity: 0.8; line-height: 1.5;">
            <b>Mission: Rapid Identification</b><br>
            Sort SAP Terms into the BLUE bucket.<br>
            Sort Dummy Terms into the RED bucket.
        </p>
        <button class="btn-start" onclick="start()">START CHALLENGE</button>
        <p style="margin-top: 20px; font-size: 13px; color: #aaa;">Point forward & flick up to toss!</p>
    </div>

    <div class="ui-panel" style="top: 20px; left: 20px;">
        <div style="color: #2ecc71; font-size: 12px; font-weight: bold; letter-spacing: 1px;">SCORE</div>
        <div id="score-val" style="color: white; font-size: 32px; font-weight: bold;">0</div>
    </div>

    <div class="ui-panel" style="top: 20px; left: 50%; transform: translateX(-50%); text-align: center;">
        <div style="color: #67e8f9; font-size: 10px; font-weight: bold; letter-spacing: 2px;">HOLDING</div>
        <div id="current-label-ui" style="color: white; font-size: 28px; font-weight: bold; background: rgba(0,0,0,0.5); padding: 8px 25px; border-radius: 20px; border: 1px solid rgba(103, 232, 249, 0.3); min-width: 120px;">---</div>
    </div>

    <div class="ui-panel" style="top: 20px; right: 20px; text-align: right;">
        <div style="color: #e67e22; font-size: 12px; font-weight: bold; letter-spacing: 1px;">TIME</div>
        <div id="time-val" style="color: white; font-size: 32px; font-weight: bold;">15</div>
    </div>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;" vr-mode-ui="enabled: false" renderer="logarithmicDepthBuffer: true">
        
        <a-entity id="world-root">
            <a-entity id="basket-sap" position="-1.8 -1.5 -7">
                <a-cylinder color="#3498db" height="1.2" radius="0.75" open-ended="true" side="double"></a-cylinder>
                <a-text value="SAP TERM" align="center" position="0 1.5 0" scale="2.5 2.5 2.5" color="#3498db" bold="true"></a-text>
                <a-ring color="black" radius-inner="0.6" radius-outer="0.9" rotation="-90 0 0" position="0 -0.59 0" opacity="0.3"></a-ring>
            </a-entity>

            <a-entity id="basket-not-sap" position="1.8 -1.5 -7">
                <a-cylinder color="#e74c3c" height="1.2" radius="0.75" open-ended="true" side="double"></a-cylinder>
                <a-text value="NOT SAP" align="center" position="0 1.5 0" scale="2.5 2.5 2.5" color="#e74c3c" bold="true"></a-text>
                <a-ring color="black" radius-inner="0.6" radius-outer="0.9" rotation="-90 0 0" position="0 -0.59 0" opacity="0.3"></a-ring>
            </a-entity>
        </a-entity>

        <a-entity id="camera-rig" position="0 1.6 0">
            <a-camera id="mainCam" look-controls="enabled: true; touchEnabled: false; magicWindowTrackingEnabled: true" wasd-controls-enabled="false">
                <a-entity cursor="fuse: false" position="0 0 -1" geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015" material="color: #FFF; shader: flat"></a-entity>
            </a-camera>
        </a-entity>
    </a-scene>

    <script>
        // --- DATA CONFIGURATION ---
        const config = {
            timerSeconds: 30,
            winThreshold: 70,
            sapTerms: ["BAPI", "ABAP", "HANA", "FIORI", "OData", "Module", "Basis", "Cloud", "ERP", "NetWeaver", "CRM", "Ariba", "S/4HANA", "UI5", "FioriLaunchpad"],
            dummyTerms: ["Pizza", "Moon", "Forest", "Cloud-9", "C#", "Java", "React", "Swift", "Banana", "Football", "Sandwich", "Bicycle", "Guitar", "Mountain", "River"]
        };

        const gameItems = [
            ...config.sapTerms.map(t => ({ label: t, target: "basket-sap" })),
            ...config.dummyTerms.map(t => ({ label: t, target: "basket-not-sap" }))
        ];

        let score = 0;
        let timeLeft = config.timerSeconds;
        let canThrow = false;
        let gameActive = false;
        let currentItem = null;
        let timerInterval;

        const scene = document.querySelector('a-scene');
        const cam = document.querySelector('#mainCam');
        const flashOverlay = document.getElementById('flash-overlay');

        function prepareNextItem() {
            currentItem = gameItems[Math.floor(Math.random() * gameItems.length)];
            document.getElementById('current-label-ui').innerText = currentItem.label.toUpperCase();
        }

        function start() {
            document.getElementById('overlay').style.display = 'none';
            score = 0;
            timeLeft = config.timerSeconds;
            gameActive = true;
            canThrow = true;
            document.getElementById('score-val').innerText = "0";
            document.getElementById('time-val').innerText = timeLeft;
            document.getElementById('time-val').style.color = "white";
            prepareNextItem();
            startTimer();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const timerEl = document.getElementById('time-val');
                timerEl.innerText = timeLeft;
                if (timeLeft <= 5) timerEl.style.color = "#ff3333";
                if (timeLeft <= 0) endGame();
            }, 1000);
        }

        function endGame() {
            clearInterval(timerInterval);
            gameActive = false;
            canThrow = false;

            const didWin = score >= config.winThreshold;

            if (window.opener) {
                window.opener.postMessage({
                    type: "AR_GAME_RESULT",
                    win: didWin,
                    metadata: {
                        score: score,
                        minScoreToWin: config.winThreshold,
                        timePlayed: config.timerSeconds,
                        gameName: "SAP Fast Tap"
                    }
                }, "*");
            }

            alert(didWin ? "MISSION COMPLETE! Threshold Reached." : "TIME'S UP! Score: " + score);
            window.close();
        }

        // --- INTERACTION LOGIC ---
        let startX, startY;
        window.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });

        window.addEventListener('touchend', (e) => {
            if (!canThrow || !gameActive) return;
            let diffX = e.changedTouches[0].clientX - startX;
            let diffY = startY - e.changedTouches[0].clientY;

            if (diffY > 60) {
                canThrow = false;
                throwBall(diffX / window.innerWidth);
                setTimeout(() => { if (gameActive) canThrow = true; }, 400); 
            }
        });

        // function throwBall(tilt) {
        //     const itemBeingThrown = currentItem;
        //     const wrapper = document.createElement('a-entity');
        //     const ball = document.createElement('a-sphere');

        //     ball.setAttribute('radius', '0.15');
        //     ball.setAttribute('color', 'white');
        //     ball.setAttribute('material', 'emissive: #ffffff; emissiveIntensity: 0.3');
        //     wrapper.appendChild(ball);
        //     scene.appendChild(wrapper);

        //     prepareNextItem(); // Update Top UI for next turn immediately

        //     const startPos = new THREE.Vector3();
        //     cam.object3D.getWorldPosition(startPos);
        //     const direction = new THREE.Vector3(0, 0, -1);
        //     direction.applyQuaternion(cam.object3D.quaternion);

        //     const sideVector = new THREE.Vector3(1, 0, 0);
        //     sideVector.applyQuaternion(cam.object3D.quaternion);
        //     direction.addScaledVector(sideVector, tilt * 2.5); 

        //     const endPos = {
        //         x: startPos.x + direction.x * 8,
        //         y: -1.5,
        //         z: startPos.z + direction.z * 8
        //     };

        //     wrapper.setAttribute('animation', { 
        //         property: 'position', 
        //         to: `${endPos.x} ${endPos.y} ${endPos.z}`, 
        //         dur: 800, 
        //         easing: 'easeOutQuad' 
        //     });

        //     setTimeout(() => {
        //         const buckets = ['basket-sap', 'basket-not-sap'];
        //         let hitResult = null;

        //         buckets.forEach(id => {
        //             const bucket = document.getElementById(id);
        //             const bPos = bucket.object3D.position;
        //             const dist = Math.sqrt(Math.pow(endPos.x - bPos.x, 2) + Math.pow(endPos.z - bPos.z, 2));

        //             if (dist < 1.0) {
        //                 hitResult = (id === itemBeingThrown.target);
        //                 if (hitResult) {
        //                     score += 10;
        //                     wiggleBucket(bucket, true);
        //                 } else {
        //                     score -= 5;
        //                     wiggleBucket(bucket, false);
        //                 }
        //                 document.getElementById('score-val').innerText = score;
        //             }
        //         });
        //         if (wrapper.parentNode) wrapper.parentNode.removeChild(wrapper);
        //     }, 850);
        // }


        function throwBall(tilt) {
    const itemBeingThrown = currentItem;
    const wrapper = document.createElement('a-entity');
    const ball = document.createElement('a-sphere');

    ball.setAttribute('radius', '0.15');
    ball.setAttribute('color', 'white');
    ball.setAttribute('material', 'emissive: #ffffff; emissiveIntensity: 0.3');
    
    wrapper.appendChild(ball);
    scene.appendChild(wrapper);

    prepareNextItem();

    const startPos = new THREE.Vector3();
    cam.object3D.getWorldPosition(startPos);
    const direction = new THREE.Vector3(0, 0, -1);
    direction.applyQuaternion(cam.object3D.quaternion);

    const sideVector = new THREE.Vector3(1, 0, 0);
    sideVector.applyQuaternion(cam.object3D.quaternion);
    
    // Horizontal direction based on swipe tilt
    direction.addScaledVector(sideVector, tilt * 3); 

    // Initial spawn slightly in front and below eye-level
    wrapper.setAttribute('position', {
        x: startPos.x + direction.x * 0.5,
        y: startPos.y - 0.2,
        z: startPos.z + direction.z * 0.5
    });

    const travelDistance = 8;
    const endPos = {
        x: startPos.x + direction.x * travelDistance,
        y: -1.5, // Floor level
        z: startPos.z + direction.z * travelDistance
    };

    // 1. FORWARD MOVEMENT (Wrapper)
    wrapper.setAttribute('animation', {
        property: 'position',
        to: `${endPos.x} ${endPos.y} ${endPos.z}`,
        dur: 1100,
        easing: 'linear'
    });

    // 2. THE TOSS ARC (Ball inside Wrapper)
    // Rise up
    ball.setAttribute('animation__up', {
        property: 'position',
        from: '0 0 0',
        to: '0 1.5 0', // Height of the toss
        dur: 450,
        easing: 'easeOutQuad'
    });

    // Fall down
    setTimeout(() => {
        ball.setAttribute('animation__down', {
            property: 'position',
            to: '0 0 0',
            dur: 650,
            easing: 'easeInQuad'
        });
    }, 450);

    // 3. COLLISION CHECK (Wait for the fall to complete)
    setTimeout(() => {
        const buckets = ['basket-sap', 'basket-not-sap'];
        buckets.forEach(id => {
            const bucket = document.getElementById(id);
            const bPos = bucket.object3D.position;
            
            // Check distance at the landing coordinate
            const dist = Math.sqrt(
                Math.pow(endPos.x - bPos.x, 2) + 
                Math.pow(endPos.z - bPos.z, 2)
            );

            if (dist < 0.85) { // Radius of "entry"
                if (id === itemBeingThrown.target) {
                    score += 10;
                    wiggleBucket(bucket, true);
                } else {
                    score -= 5;
                    wiggleBucket(bucket, false);
                }
                document.getElementById('score-val').innerText = score;
            }
        });

        if (wrapper.parentNode) wrapper.parentNode.removeChild(wrapper);
    }, 1150);
}

        function wiggleBucket(entity, isCorrect) {
            // Screen Flash
            flashOverlay.style.backgroundColor = isCorrect ? 'rgba(46, 204, 113, 0.3)' : 'rgba(231, 76, 60, 0.3)';
            flashOverlay.style.opacity = '1';
            setTimeout(() => { flashOverlay.style.opacity = '0'; }, 150);

            // Bucket Animation
            entity.setAttribute('animation__wiggle', {
                property: 'rotation', to: '0 0 10', dur: 100, dir: 'alternate', loop: 4, easing: 'easeInOutQuad'
            });
            const cylinder = entity.querySelector('a-cylinder');
            const originalColor = cylinder.getAttribute('color');
            cylinder.setAttribute('color', isCorrect ? '#2ecc71' : '#ff3333');
            
            setTimeout(() => {
                cylinder.setAttribute('color', originalColor);
                entity.setAttribute('rotation', '0 0 0');
                entity.removeAttribute('animation__wiggle');
            }, 400);
        }
    </script>
</body>
</html>